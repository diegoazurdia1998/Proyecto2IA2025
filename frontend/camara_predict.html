<div style="margin-top: 30px;">
  <!-- Video y canvas -->
  <video id="video" width="320" height="240" autoplay></video>

  <!-- Canvas de predicci√≥n (48x48) -->
  <canvas id="canvas_pred" width="48" height="48" style="display:none;"></canvas>

  <!-- Canvas para previsualizaci√≥n (224x224) -->
  <canvas id="canvas_preview" width="224" height="224" style="display:none;"></canvas>

  <br>

  <!-- Bot√≥n de inicio -->
  <button id="iniciar" style="
    padding: 10px 20px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    background-color: #ffffff;
    color: #000000;
    cursor: pointer;
    margin-top: 15px;
  ">Iniciar predicci√≥n</button>

  <!-- Resultado -->
  <div id="resultado" style="
    font-size: 18px;
    background: #ffffff;
    color: #000000;
    padding: 10px 20px;
    display: inline-block;
    border-radius: 10px;
    margin-top: 10px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    white-space: pre-wrap;
    text-align: left;
    max-width: 90%;
  ">‚è≥ Esperando...</div>

  <!-- Imagen capturada -->
  <div id="preview-contenedor" style="margin-top: 20px;"></div>
</div>

<script>
  const video = document.getElementById('video');
  const canvasPred = document.getElementById('canvas_pred');
  const ctxPred = canvasPred.getContext('2d');

  const canvasPreview = document.getElementById('canvas_preview');
  const ctxPreview = canvasPreview.getContext('2d');

  const resultado = document.getElementById('resultado');
  const iniciarBtn = document.getElementById('iniciar');
  const modeloSeleccionado = document.getElementById("modelo-seleccionado");
  const previewContenedor = document.getElementById('preview-contenedor');

  let intervalo = null;

  // Activar c√°mara
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(err => {
      resultado.innerText = "‚ùå No se pudo acceder a la c√°mara.";
    });

  function enviarCuadro() {
    const modelo = modeloSeleccionado.value;
    if (!modelo) {
      resultado.innerText = "‚ùå Modelo no seleccionado.";
      return;
    }

    // Captura 48x48 para predicci√≥n
    ctxPred.drawImage(video, 0, 0, 48, 48);
    const imagenData = canvasPred.toDataURL('image/jpeg');

    // Captura 224x224 para mostrar al usuario
    ctxPreview.drawImage(video, 0, 0, 224, 224);
    const imagenPreview = canvasPreview.toDataURL('image/jpeg');

    // Mostrar imagen en pantalla
    previewContenedor.innerHTML = `
      <img src="${imagenPreview}" alt="Captura actual"
           style="border-radius: 10px; max-width: 100%; box-shadow: 0 0 10px rgba(0,0,0,0.4); margin-top: 10px;">
    `;

    // Enviar a backend para analizar
    fetch('predecir_ajax.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ imagen: imagenData, modelo: modelo })
    })
    .then(res => res.json())
    .then(data => {
      console.log("üì¶ Respuesta del servidor:", data);

      if (data.emocion && data.probabilidad !== undefined) {
        resultado.innerText = `üòä ${data.emocion} (${data.probabilidad}%)`;
      } else {
        // Mostrar el contenido de debug_salida.txt si falla
        fetch('leer_debug.php')
          .then(res => res.text())
          .then(texto => {
            resultado.innerText = "‚ö†Ô∏è Debug del backend:\n" + texto;
          });
      }
    })
    .catch(err => {
      resultado.innerText = "‚ùå Error de conexi√≥n con el servidor.";
    });
  }

  iniciarBtn.addEventListener("click", () => {
    if (intervalo) clearInterval(intervalo);
    resultado.innerText = "üîÑ Iniciando predicci√≥n autom√°tica...";
    intervalo = setInterval(enviarCuadro, 2000); // cada 2 segundos
  });
</script>
